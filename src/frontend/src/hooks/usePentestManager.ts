import { useState, useCallback } from 'react';

interface PentestManagerReturn {
  // Informe
  reportContent: string;
  setReportContent: (content: string) => void;
  loadReportContent: () => Promise<void>;
  saveEditedReport: () => Promise<boolean>;
  uploadReport: (file: File) => Promise<boolean>;
  downloadReport: () => void;
  generateReport: () => Promise<boolean>;
  updateReport: () => Promise<boolean>;
  generateNewReport: () => Promise<boolean>;
  
  // Hist√≥rico del chat
  historyContent: string;
  setHistoryContent: (content: string) => void;
  loadHistoryContent: () => Promise<void>;
  saveEditedHistory: () => Promise<boolean>;
  uploadHistory: (file: File) => Promise<boolean>;
  downloadHistory: () => void;
  
  // General
  clearPentest: () => Promise<boolean>;
  isProcessing: boolean;
}

const getApiBaseUrl = () => {
  if (import.meta.env.VITE_API_BASE_URL) {
    return import.meta.env.VITE_API_BASE_URL;
  }
  const port = import.meta.env.VITE_API_PORT || '7777';
  const host = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' ? 'localhost' : window.location.hostname;
  return `http://${host}:${port}`;
};
const API_BASE_URL = getApiBaseUrl();

export const usePentestManager = (
  sessionId: string,
  onStatusMessage: (message: string) => void
): PentestManagerReturn => {
  const [reportContent, setReportContent] = useState("");
  const [historyContent, setHistoryContent] = useState("");
  const [isProcessing, setIsProcessing] = useState(false);

  // === Funciones del informe ===
  const loadReportContent = useCallback(async () => {
    try {
      const response = await fetch(`${API_BASE_URL}/obtener-pentesting/${sessionId}`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      setReportContent(data.content || "");
    } catch (error) {
      console.error("Error loading report content:", error);
      const errorMessage = error instanceof Error ? error.message : "Error desconocido";
      onStatusMessage(`‚ùå Error cargando contenido del informe: ${errorMessage}`);
    }
  }, [sessionId, onStatusMessage]);

  // === Funciones del hist√≥rico del chat ===
  const loadHistoryContent = useCallback(async () => {
    try {
      const response = await fetch(`${API_BASE_URL}/chats/${sessionId}/raw`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      setHistoryContent(data.content || "");
    } catch (error) {
      console.error("Error loading history content:", error);
      const errorMessage = error instanceof Error ? error.message : "Error desconocido";
      onStatusMessage(`‚ùå Error cargando hist√≥rico del chat: ${errorMessage}`);
    }
  }, [sessionId, onStatusMessage]);

  const saveEditedReport = useCallback(async (): Promise<boolean> => {
    try {
      const response = await fetch(`${API_BASE_URL}/editar-informe/${sessionId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: reportContent }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      onStatusMessage("üíæ Informe editado correctamente");
      return true;
    } catch (error) {
      console.error("Error saving edited report:", error);
      const errorMessage = error instanceof Error ? error.message : "Error desconocido";
      onStatusMessage(`‚ùå Error editando informe: ${errorMessage}`);
      return false;
    }
  }, [sessionId, reportContent, onStatusMessage]);

  const saveEditedHistory = useCallback(async (): Promise<boolean> => {
    try {
      const response = await fetch(`${API_BASE_URL}/chats/${sessionId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: historyContent }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      onStatusMessage("üíæ Hist√≥rico editado correctamente");
      return true;
    } catch (error) {
      console.error("Error saving edited history:", error);
      const errorMessage = error instanceof Error ? error.message : "Error desconocido";
      onStatusMessage(`‚ùå Error editando hist√≥rico: ${errorMessage}`);
      return false;
    }
  }, [sessionId, historyContent, onStatusMessage]);

  // === Funciones de generaci√≥n de informes ===
  const generateReport = useCallback(async (): Promise<boolean> => {
    setIsProcessing(true);
    try {
      onStatusMessage("üîÑ Generando informe...");
      const response = await fetch(`${API_BASE_URL}/generar-informe/${sessionId}`, {
        method: "POST",
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      onStatusMessage("‚úÖ Informe generado correctamente");
      await loadReportContent(); // Recargar contenido
      return true;
    } catch (error) {
      console.error("Error generating report:", error);
      const errorMessage = error instanceof Error ? error.message : "Error desconocido";
      onStatusMessage(`‚ùå Error generando informe: ${errorMessage}`);
      return false;
    } finally {
      setIsProcessing(false);
    }
  }, [sessionId, onStatusMessage, loadReportContent]);

  const updateReport = useCallback(async (): Promise<boolean> => {
    setIsProcessing(true);
    try {
      onStatusMessage("üîÑ Actualizando informe...");
      const response = await fetch(`${API_BASE_URL}/actualizar-informe/${sessionId}`, {
        method: "POST",
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      onStatusMessage("‚úÖ Informe actualizado correctamente");
      await loadReportContent(); // Recargar contenido
      return true;
    } catch (error) {
      console.error("Error updating report:", error);
      const errorMessage = error instanceof Error ? error.message : "Error desconocido";
      onStatusMessage(`‚ùå Error actualizando informe: ${errorMessage}`);
      return false;
    } finally {
      setIsProcessing(false);
    }
  }, [sessionId, onStatusMessage, loadReportContent]);

  const generateNewReport = useCallback(async (): Promise<boolean> => {
    setIsProcessing(true);
    try {
      onStatusMessage("üîÑ Generando nuevo informe...");
      const response = await fetch(`${API_BASE_URL}/generar-nuevo-informe/${sessionId}`, {
        method: "POST",
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      onStatusMessage("‚úÖ Nuevo informe generado correctamente");
      await loadReportContent(); // Recargar contenido
      return true;
    } catch (error) {
      console.error("Error generating new report:", error);
      const errorMessage = error instanceof Error ? error.message : "Error desconocido";
      onStatusMessage(`‚ùå Error generando nuevo informe: ${errorMessage}`);
      return false;
    } finally {
      setIsProcessing(false);
    }
  }, [sessionId, onStatusMessage, loadReportContent]);

  const uploadReport = useCallback(async (file: File): Promise<boolean> => {
    try {
      // Validar tama√±o del archivo (10MB m√°ximo)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        onStatusMessage("‚ùå Archivo demasiado grande (m√°ximo 10MB)");
        return false;
      }

      // Validar tipo de archivo
      if (!file.name.toLowerCase().endsWith('.md')) {
        onStatusMessage("‚ùå Solo se permiten archivos .md");
        return false;
      }

      const text = await file.text();
      
      const response = await fetch(`${API_BASE_URL}/subir-informe/${sessionId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: text }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      setReportContent(text);
      onStatusMessage("üì§ Informe subido correctamente");
      return true;
    } catch (error) {
      console.error("Error uploading report:", error);
      const errorMessage = error instanceof Error ? error.message : "Error desconocido";
      onStatusMessage(`‚ùå Error subiendo informe: ${errorMessage}`);
      return false;
    }
  }, [sessionId, onStatusMessage]);

  const uploadHistory = useCallback(async (file: File): Promise<boolean> => {
    try {
      // Validar tama√±o del archivo (10MB m√°ximo)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        onStatusMessage("‚ùå Archivo demasiado grande (m√°ximo 10MB)");
        return false;
      }

      // Validar tipo de archivo
      if (!file.name.toLowerCase().endsWith('.md')) {
        onStatusMessage("‚ùå Solo se permiten archivos .md");
        return false;
      }

      const text = await file.text();
      
      const response = await fetch(`${API_BASE_URL}/chats/${sessionId}/upload`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: text }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      setHistoryContent(text);
      onStatusMessage("üì§ Hist√≥rico subido correctamente");
      return true;
    } catch (error) {
      console.error("Error uploading history:", error);
      const errorMessage = error instanceof Error ? error.message : "Error desconocido";
      onStatusMessage(`‚ùå Error subiendo hist√≥rico: ${errorMessage}`);
      return false;
    }
  }, [sessionId, onStatusMessage]);

  const clearPentest = useCallback(async (): Promise<boolean> => {
    try {
      const response = await fetch(`${API_BASE_URL}/borrar-pentesting/${sessionId}`, {
        method: "DELETE",
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      setReportContent("");
      setHistoryContent("");
      onStatusMessage("üóëÔ∏è Datos de pentesting borrados");
      return true;
    } catch (error) {
      console.error("Error clearing pentesting:", error);
      const errorMessage = error instanceof Error ? error.message : "Error desconocido";
      onStatusMessage(`‚ùå Error borrando datos de pentesting: ${errorMessage}`);
      return false;
    }
  }, [sessionId, onStatusMessage]);

  const downloadReport = useCallback(() => {
    try {
      window.open(`${API_BASE_URL}/descargar-pentesting/${sessionId}`, "_blank");
    } catch (error) {
      console.error("Error downloading report:", error);
      const errorMessage = error instanceof Error ? error.message : "Error desconocido";
      onStatusMessage(`‚ùå Error descargando informe: ${errorMessage}`);
    }
  }, [sessionId, onStatusMessage]);

  const downloadHistory = useCallback(() => {
    try {
      window.open(`${API_BASE_URL}/chats/${sessionId}/download`, "_blank");
    } catch (error) {
      console.error("Error downloading history:", error);
      const errorMessage = error instanceof Error ? error.message : "Error desconocido";
      onStatusMessage(`‚ùå Error descargando hist√≥rico: ${errorMessage}`);
    }
  }, [sessionId, onStatusMessage]);

  return {
    // Informe
    reportContent,
    setReportContent,
    loadReportContent,
    saveEditedReport,
    uploadReport,
    downloadReport,
    generateReport,
    updateReport,
    generateNewReport,
    
    // Hist√≥rico del chat
    historyContent,
    setHistoryContent,
    loadHistoryContent,
    saveEditedHistory,
    uploadHistory,
    downloadHistory,
    
    // General
    clearPentest,
    isProcessing
  };
};